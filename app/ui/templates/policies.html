{% extends "base.html" %}
{% block content %}
<h1>Policies &amp; Documents</h1>

<div class="card">
  <div class="module-head">
    <h2>Stored Documents</h2>
    <button type="button" class="module-plus" id="open-upload-document" aria-label="Upload document">+</button>
  </div>
  {% if request.query_params.get("upload") == "invalid_type" %}
  <p class="small">Only PDF, JPEG, and PNG files are allowed.</p>
  {% endif %}
  <table>
    <tr><th>ID</th><th>Type</th><th>Name</th><th>Linked Policy</th><th>Preview</th></tr>
    {% for d in documents %}
    <tr class="doc-row" data-doc-id="{{ d.id }}" data-doc-name="{{ d.filename }}">
      <td>{{ d.id }}</td>
      <td>{{ d.doc_type.value }}</td>
      <td>{{ d.filename }}</td>
      <td>{% if d.policy_id and d.policy_id in policy_by_id %}#{{ d.policy_id }}{% else %}-{% endif %}</td>
      <td><button type="button" class="open-doc" data-doc-id="{{ d.id }}">Open</button></td>
    </tr>
    {% endfor %}
  </table>
</div>

<dialog id="upload-document-dialog">
  <h3>Upload Document</h3>
  <form method="post" action="/policies/documents/upload" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <input type="hidden" name="policy_id" value="" />
    <label>Type
      <select name="doc_type">
        <option value="policy">Policy</option>
        <option value="bill">Bill</option>
        <option value="receipt">Receipt</option>
        <option value="other">Other</option>
      </select>
    </label>
    <label>File<input name="file" type="file" accept=".pdf,.jpg,.jpeg,.png,application/pdf,image/jpeg,image/png" required /></label>
    <div class="calendar-controls">
      <button type="submit">Upload</button>
      <button type="button" id="upload-document-close">Close</button>
    </div>
  </form>
</dialog>

<dialog id="view-document-dialog" class="document-viewer">
  <h3 id="view-document-title">Document</h3>
  <iframe id="view-document-frame" title="Document preview"></iframe>
  <form method="dialog">
    <button type="submit">Close</button>
  </form>
</dialog>

<script>
  (function () {
    var uploadDialog = document.getElementById("upload-document-dialog");
    var uploadOpen = document.getElementById("open-upload-document");
    var uploadClose = document.getElementById("upload-document-close");

    if (uploadOpen && uploadDialog && uploadDialog.showModal) {
      uploadOpen.addEventListener("click", function () {
        uploadDialog.showModal();
      });
    }
    if (uploadClose && uploadDialog && uploadDialog.close) {
      uploadClose.addEventListener("click", function () {
        uploadDialog.close();
      });
    }

    var viewDialog = document.getElementById("view-document-dialog");
    var viewTitle = document.getElementById("view-document-title");
    var viewFrame = document.getElementById("view-document-frame");
    var openButtons = document.querySelectorAll(".open-doc");

    openButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var docId = btn.getAttribute("data-doc-id") || "";
        if (!docId) {
          return;
        }
        var row = btn.closest("tr");
        if (viewTitle && row) {
          viewTitle.textContent = row.getAttribute("data-doc-name") || "Document";
        }
        if (viewFrame) {
          viewFrame.src = "/policies/documents/" + docId + "/view";
        }
        if (viewDialog && viewDialog.showModal) {
          viewDialog.showModal();
        }
      });
    });
  })();
</script>
{% endblock %}
