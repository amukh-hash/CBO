{% extends "base.html" %}
{% block content %}
<h1>Policies &amp; Documents</h1>
<div class="card">
  <form method="post" action="/policies/add">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <label>Provider
      <select name="provider_id">{% for p in providers %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}</select>
    </label>
    <label>Plan Type
      <select name="plan_type">{% for t in plan_types %}<option value="{{ t.value }}">{{ t.value }}</option>{% endfor %}</select>
    </label>
    <label>Policy Number<input name="policy_number" required /></label>
    <label>Monthly Premium (cents)<input name="monthly_premium_cents" type="number" min="0" value="0" /></label>
    <label>Deductible (cents)<input name="deductible_cents" type="number" value="0" /></label>
    <label>OOP Max (cents)<input name="oop_max_cents" type="number" value="0" /></label>
    <button type="submit">Add Policy</button>
  </form>
</div>
<div class="card">
  <table><tr><th>ID</th><th>Provider</th><th>Plan</th><th>Premium</th><th>Deductible</th><th>OOP Max</th></tr>
    {% for p in policies %}
    <tr>
      <td>{{ p.id }}</td>
      <td>{% if p.provider_id in provider_by_id %}{{ provider_by_id[p.provider_id].name }}{% else %}{{ p.provider_id }}{% endif %}</td>
      <td>{{ p.plan_type.value }}</td>
      <td>{{ p.monthly_premium_cents }}</td>
      <td>{{ p.deductible_cents }}</td>
      <td>{{ p.oop_max_cents }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<div class="card">
  <h2>Upload Policy/Documents</h2>
  {% if request.query_params.get("upload") == "invalid_type" %}
  <p class="small">Only PDF, JPEG, and PNG files are allowed.</p>
  {% endif %}
  <form method="post" action="/policies/documents/upload" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <label>Link to Policy
      <select name="policy_id">
        <option value="">No policy link</option>
        {% for p in policies %}
        <option value="{{ p.id }}">Policy #{{ p.id }}{% if p.provider_id in provider_by_id %} - {{ provider_by_id[p.provider_id].name }}{% endif %}</option>
        {% endfor %}
      </select>
    </label>
    <label>Type
      <select name="doc_type">
        <option value="policy">Policy</option>
        <option value="bill">Bill</option>
        <option value="receipt">Receipt</option>
        <option value="other">Other</option>
      </select>
    </label>
    <label>File<input name="file" type="file" accept=".pdf,.jpg,.jpeg,.png,application/pdf,image/jpeg,image/png" required /></label>
    <button type="submit">Upload Document</button>
  </form>
</div>
<div class="card">
  <h2>Stored Documents</h2>
  <table>
    <tr><th>ID</th><th>Type</th><th>Name</th><th>Policy</th><th>View</th></tr>
    {% for d in documents %}
    <tr>
      <td>{{ d.id }}</td>
      <td>{{ d.doc_type.value }}</td>
      <td>{{ d.filename }}</td>
      <td>{% if d.policy_id and d.policy_id in policy_by_id %}#{{ d.policy_id }}{% else %}-{% endif %}</td>
      <td><a href="/policies/documents/{{ d.id }}/view" target="_blank" rel="noopener">Open</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endblock %}
