{% extends "base.html" %}
{% block content %}
<h1>Expenses</h1>
<div class="card">
  {% if upload_error == "invalid_type" %}
  <p class="small">Only PDF files are allowed for expense receipts.</p>
  {% endif %}
  <form method="post" action="/expenses/add" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <label>Amount (USD)<input name="amount_usd" type="number" min="0" step="0.01" required /></label>
    <label>Incurred At<input name="incurred_at" type="date" required /></label>
    <label>Category<input name="category" value="medical" /></label>
    <label>Memo<input name="memo" /></label>
    <label>Receipt PDF (optional)
      <input name="receipt_file" type="file" accept=".pdf,application/pdf" />
    </label>
    <button type="submit">Add Expense</button>
  </form>
</div>
<div class="card">
  <table>
    <tr><th>ID</th><th>Category</th><th>Amount</th><th>Date</th><th>Receipt</th></tr>
    {% for row in expense_rows %}
    <tr>
      <td>{{ row.expense.id }}</td>
      <td>{{ row.expense.category }}</td>
      <td>${{ '%.2f'|format(row.expense.amount_cents / 100) }}</td>
      <td>{{ row.expense.incurred_at }}</td>
      <td>
        {% if row.receipt %}
        <button type="button" class="open-expense-receipt" data-doc-id="{{ row.receipt.id }}" data-doc-name="{{ row.receipt.filename }}">Open PDF</button>
        {% else %}
        -
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
<div class="grid">
  <div class="card">
    <strong>Monthly Expenses So Far</strong>
    <div>${{ '%.2f'|format(monthly_expenses_so_far / 100) }}</div>
  </div>
  <div class="card">
    <strong>Yearly Expenses So Far</strong>
    <div>${{ '%.2f'|format(yearly_expenses_so_far / 100) }}</div>
  </div>
  <div class="card">
    <strong>Estimated Total Yearly Expenses</strong>
    <div>${{ '%.2f'|format(estimated_total_yearly_cents / 100) }}</div>
  </div>
  <div class="card">
    <strong>Monthly Premium Total</strong>
    <div>${{ '%.2f'|format(monthly_premium_cents / 100) }}</div>
  </div>
  <div class="card">
    <strong>Average Monthly Expenses (YTD)</strong>
    <div>${{ '%.2f'|format(avg_monthly_expenses_cents / 100) }}</div>
  </div>
  <div class="card">
    <strong>Appointments (YTD)</strong>
    <div>{{ appointments_ytd }}</div>
  </div>
  <div class="card">
    <strong>Average Appointment Invoice</strong>
    <div>${{ '%.2f'|format(avg_invoice_per_appointment_cents / 100) }}</div>
  </div>
</div>

<dialog id="expense-receipt-dialog" class="document-viewer">
  <h3 id="expense-receipt-title">Expense Receipt</h3>
  <iframe id="expense-receipt-frame" title="Expense receipt preview"></iframe>
  <form method="dialog">
    <button type="submit">Close</button>
  </form>
</dialog>

<script>
  (function () {
    var dialog = document.getElementById("expense-receipt-dialog");
    var frame = document.getElementById("expense-receipt-frame");
    var title = document.getElementById("expense-receipt-title");
    var buttons = document.querySelectorAll(".open-expense-receipt");

    buttons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var docId = btn.getAttribute("data-doc-id") || "";
        var docName = btn.getAttribute("data-doc-name") || "Expense Receipt";
        if (!docId || !dialog || !dialog.showModal || !frame) {
          return;
        }
        if (title) {
          title.textContent = docName;
        }
        frame.src = "/policies/documents/" + docId + "/view";
        dialog.showModal();
      });
    });
  })();
</script>
{% endblock %}
