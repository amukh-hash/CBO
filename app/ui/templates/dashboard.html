{% extends "base.html" %}
{% block content %}
<h1>Dashboard</h1>

<div class="card calendar-module">
  <div class="module-head">
    <h2>Appointments Calendar</h2>
    {% if providers %}
    <button type="button" class="module-plus" id="open-add-appointment" aria-label="Add appointment">+</button>
    {% endif %}
  </div>
  <div class="calendar-controls">
    <a href="/?year={{ prev_year }}&month={{ prev_month }}" aria-label="Previous month">Previous</a>
    <strong>{{ current_month_label }}</strong>
    <a href="/?year={{ next_year }}&month={{ next_month }}" aria-label="Next month">Next</a>
  </div>
  <table class="calendar-table">
    <thead>
      <tr>
        <th scope="col">Mon</th>
        <th scope="col">Tue</th>
        <th scope="col">Wed</th>
        <th scope="col">Thu</th>
        <th scope="col">Fri</th>
        <th scope="col">Sat</th>
        <th scope="col">Sun</th>
      </tr>
    </thead>
    <tbody>
      {% for week in weeks %}
      <tr>
        {% for day in week %}
        <td class="calendar-day{% if not day.in_month %} out-month{% endif %}">
          <div class="day-number">{{ day.day_num }}</div>
          {% for appt in day.appointments %}
          <button
            type="button"
            class="appointment-pill"
            style="--appt-color: {{ appt.provider_color }};"
            data-appointment-id="{{ appt.id }}"
            data-provider-id="{{ appt.provider_id }}"
            data-provider="{{ appt.provider_name }}"
            data-specialty="{{ appt.provider_specialty }}"
            data-time="{{ appt.scheduled_at_iso }}"
            data-date="{{ appt.scheduled_date }}"
            data-time-input="{{ appt.scheduled_time }}"
            data-display-time="{{ appt.time }}"
            data-invoice="{{ appt.estimated_invoice_cents }}"
            data-invoice-usd="{{ appt.estimated_invoice_usd }}"
            data-location="{{ appt.location_name }}"
            data-address="{{ appt.facility_address }}"
            data-prep="{{ appt.prep_notes }}"
            data-notes="{{ appt.notes }}"
          >
            {{ appt.time }} {{ appt.provider_name }}
          </button>
          {% endfor %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="grid month-summary-grid">
  <div class="card"><strong>Month Appointments</strong><div>{{ month_appointment_count }}</div></div>
  <div class="card"><strong>Month Expenses</strong><div>${{ '%.2f'|format(monthly_expense / 100) }}</div></div>
  <div class="card"><strong>Month Premium</strong><div>${{ '%.2f'|format(monthly_premium / 100) }}</div></div>
  <div class="card"><strong>Month Total</strong><div>${{ '%.2f'|format(monthly_total / 100) }}</div></div>
  <div class="card"><strong>Providers</strong><div>{{ provider_count }}</div></div>
  <div class="card"><strong>Documents</strong><div>{{ docs_count }}</div></div>
</div>

<div class="card">
  <h2>Recent Expenses</h2>
  <table>
    <tr><th>ID</th><th>Category</th><th>Amount</th><th>Date</th></tr>
    {% for e in recent %}
    <tr>
      <td>{{ e.id }}</td>
      <td>{{ e.category }}</td>
      <td>${{ '%.2f'|format(e.amount_cents / 100) }}</td>
      <td>{{ e.incurred_at }}</td>
    </tr>
    {% endfor %}
  </table>
</div>

<dialog id="add-appointment-dialog">
  <h3>Add Appointment</h3>
  {% if providers %}
  <form method="post" action="/appointments/add" id="add-appointment-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <label>Provider
      <select name="provider_id" id="add-provider-select" required>
        {% for p in providers %}
        <option
          value="{{ p.id }}"
          data-copay-usd="{{ '%.2f'|format(p.estimated_copay_cents / 100) }}"
          data-addresses='{{ provider_addresses_by_id.get(p.id, []) | tojson }}'
        >
          {{ p.name }}{% if p.specialty %} ({{ p.specialty }}){% endif %}
        </option>
        {% endfor %}
      </select>
    </label>
    <label>Date<input name="appointment_date" type="date" required /></label>
    <label>Time<input name="appointment_time" type="time" required /></label>
    <label>Estimated Invoice (USD)
      <input name="estimated_invoice_usd" id="add-estimated-invoice" type="number" min="0" step="0.01" value="0.00" required />
    </label>
    <label>Location<input name="location_name" placeholder="Office name / facility" /></label>
    <label>Saved Provider Address
      <select id="add-address-select">
        <option value="">Custom / type below</option>
      </select>
    </label>
    <label>Facility Address<textarea name="facility_address" id="add-facility-address" rows="2" placeholder="Street, city, state"></textarea></label>
    <label>Notes To Bring Up<textarea name="prep_notes" rows="3" placeholder="Questions or updates for this visit"></textarea></label>
    <label>Appointment Notes<textarea name="notes" rows="3" placeholder="Any context for this appointment"></textarea></label>
    <div class="calendar-controls">
      <button type="submit">Add Appointment</button>
      <button type="button" id="add-appointment-close">Close</button>
    </div>
  </form>
  {% else %}
  <p class="small">Add a provider first before scheduling appointments.</p>
  {% endif %}
</dialog>

<dialog id="appointment-dialog">
  <h3>Edit Appointment</h3>
  <form method="post" action="/appointments/update" id="appointment-edit-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <input type="hidden" name="appointment_id" id="dialog-appointment-id" />
    <label>Provider
      <select name="provider_id" id="dialog-provider-id" required>
        {% for p in providers %}
        <option
          value="{{ p.id }}"
          data-copay-usd="{{ '%.2f'|format(p.estimated_copay_cents / 100) }}"
          data-addresses='{{ provider_addresses_by_id.get(p.id, []) | tojson }}'
        >
          {{ p.name }}{% if p.specialty %} ({{ p.specialty }}){% endif %}
        </option>
        {% endfor %}
      </select>
    </label>
    <label>Date<input name="appointment_date" id="dialog-date" type="date" required /></label>
    <label>Time<input name="appointment_time" id="dialog-time-input" type="time" required /></label>
    <label>Estimated Invoice (USD)
      <input name="estimated_invoice_usd" id="dialog-invoice-input" type="number" min="0" step="0.01" required />
    </label>
    <label>Location<input name="location_name" id="dialog-location-input" /></label>
    <label>Saved Provider Address
      <select id="dialog-address-select">
        <option value="">Custom / type below</option>
      </select>
    </label>
    <label>Facility Address<textarea name="facility_address" id="dialog-address-input" rows="2"></textarea></label>
    <label>Notes To Bring Up<textarea name="prep_notes" id="dialog-prep-input" rows="3"></textarea></label>
    <label>Appointment Notes<textarea name="notes" id="dialog-notes-input" rows="3"></textarea></label>
    <p><strong>Current Timestamp:</strong> <span id="dialog-time"></span></p>
    <div class="calendar-controls">
      <button type="submit">Save Changes</button>
      <button type="button" id="dialog-close">Close</button>
    </div>
  </form>
  <form method="post" action="/appointments/delete" id="appointment-delete-form" class="dialog-danger-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <input type="hidden" name="appointment_id" id="dialog-delete-appointment-id" />
    <button type="submit" class="danger-button">Delete Appointment</button>
  </form>
</dialog>

<script>
  (function () {
    var parseAddresses = function (selectEl) {
      if (!selectEl || !selectEl.options.length) {
        return [];
      }
      var selected = selectEl.options[selectEl.selectedIndex];
      if (!selected) {
        return [];
      }
      try {
        return JSON.parse(selected.getAttribute("data-addresses") || "[]");
      } catch (err) {
        return [];
      }
    };

    var populateAddressSelect = function (addressSelect, addresses, currentValue) {
      if (!addressSelect) {
        return;
      }
      addressSelect.innerHTML = "";
      var customOpt = document.createElement("option");
      customOpt.value = "";
      customOpt.textContent = "Custom / type below";
      addressSelect.appendChild(customOpt);
      addresses.forEach(function (address) {
        var opt = document.createElement("option");
        opt.value = address;
        opt.textContent = address;
        addressSelect.appendChild(opt);
      });
      if (currentValue && addresses.indexOf(currentValue) !== -1) {
        addressSelect.value = currentValue;
      } else {
        addressSelect.value = "";
      }
    };

    var wireAddressCopy = function (addressSelect, addressInput) {
      if (!addressSelect || !addressInput) {
        return;
      }
      addressSelect.addEventListener("change", function () {
        if (addressSelect.value) {
          addressInput.value = addressSelect.value;
        }
      });
    };

    var addDialog = document.getElementById("add-appointment-dialog");
    var openAddButton = document.getElementById("open-add-appointment");
    var closeAddButton = document.getElementById("add-appointment-close");
    var addProviderSelect = document.getElementById("add-provider-select");
    var addInvoiceInput = document.getElementById("add-estimated-invoice");
    var addAddressSelect = document.getElementById("add-address-select");
    var addAddressInput = document.getElementById("add-facility-address");

    if (openAddButton && addDialog && addDialog.showModal) {
      openAddButton.addEventListener("click", function () {
        if (addProviderSelect && addInvoiceInput) {
          var selected = addProviderSelect.options[addProviderSelect.selectedIndex];
          addInvoiceInput.value = selected ? (selected.getAttribute("data-copay-usd") || "0.00") : "0.00";
          populateAddressSelect(addAddressSelect, parseAddresses(addProviderSelect), addAddressInput ? addAddressInput.value : "");
        }
        addDialog.showModal();
      });
    }
    if (closeAddButton && addDialog && addDialog.close) {
      closeAddButton.addEventListener("click", function () {
        addDialog.close();
      });
    }
    if (addProviderSelect) {
      addProviderSelect.addEventListener("change", function () {
        var selected = addProviderSelect.options[addProviderSelect.selectedIndex];
        if (addInvoiceInput && selected) {
          addInvoiceInput.value = selected.getAttribute("data-copay-usd") || "0.00";
        }
        populateAddressSelect(addAddressSelect, parseAddresses(addProviderSelect), "");
      });
    }
    wireAddressCopy(addAddressSelect, addAddressInput);

    var dialog = document.getElementById("appointment-dialog");
    var dialogClose = document.getElementById("dialog-close");
    var pills = document.querySelectorAll(".appointment-pill");
    var editProviderSelect = document.getElementById("dialog-provider-id");
    var editAddressSelect = document.getElementById("dialog-address-select");
    var editAddressInput = document.getElementById("dialog-address-input");

    if (dialogClose && dialog && dialog.close) {
      dialogClose.addEventListener("click", function () {
        dialog.close();
      });
    }

    if (editProviderSelect) {
      editProviderSelect.addEventListener("change", function () {
        populateAddressSelect(editAddressSelect, parseAddresses(editProviderSelect), editAddressInput ? editAddressInput.value : "");
      });
    }
    wireAddressCopy(editAddressSelect, editAddressInput);

    pills.forEach(function (pill) {
      pill.addEventListener("click", function () {
        document.getElementById("dialog-appointment-id").value = pill.dataset.appointmentId || "";
        document.getElementById("dialog-delete-appointment-id").value = pill.dataset.appointmentId || "";
        document.getElementById("dialog-provider-id").value = pill.dataset.providerId || "";
        document.getElementById("dialog-date").value = pill.dataset.date || "";
        document.getElementById("dialog-time-input").value = pill.dataset.timeInput || "";
        document.getElementById("dialog-invoice-input").value = pill.dataset.invoiceUsd || "0.00";
        document.getElementById("dialog-location-input").value = pill.dataset.location || "";
        document.getElementById("dialog-address-input").value = pill.dataset.address || "";
        document.getElementById("dialog-prep-input").value = pill.dataset.prep || "";
        document.getElementById("dialog-notes-input").value = pill.dataset.notes || "";
        document.getElementById("dialog-time").textContent = pill.dataset.time || "";
        populateAddressSelect(editAddressSelect, parseAddresses(editProviderSelect), pill.dataset.address || "");
        if (dialog && dialog.showModal) {
          dialog.showModal();
        }
      });
    });
  })();
</script>
{% endblock %}
